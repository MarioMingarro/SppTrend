---
title: "Vignette SppTrend"
date: "2025-12"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to SppTrend}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = FALSE
)
```

# Introduction

The `SppTrend` package provides a statistical framework to analyze temporal shifts in species occurrences in relation to environmental drivers. By comparing individual species' trajectories against an aggregate overall trend, the package classifies biological responses into spatial and thermal strategies.

Detailed information is available in `README`.

# Workflow implementation

## 1. Installation and dependencies

```{r}
# Install the development version from CRAN or GitHub
# install.packages("SppTrend")
# devtools::install_github("MarioMingarro/SppTrend")

library(SppTrend)
library(knitr)
library(DT)
library(ggplot2)
library(rnaturalearth)
library(sf)
library(readr)
```

## 2. Data acquisition and pre-processing

The package requires a `data frame` with species names, coordinates (WGS84), and temporal information (Year/Month).

*Note:*

Ensure that the column names in your input dataset match the default names expected by the `SppTrend` functions. 

These default names are:

- Species Name: `species`

- Year: `year`

- Month: `month`

- Longitude: `lon`

- Latitude: `lat`

Environmental response variables (if applicable):

  - Elevation: `ele`
  - Temperature: `tme`
  - Maximum temperature: `tmx`
  - Minimum temperature: `tmn`

```{r, echo = FALSE}
path_to_file <- system.file("extdata", "example_ranidae.csv", package = "SppTrend")
if (path_to_file == "") {
  path_to_file <- "../inst/extdata/example_ranidae.CSV"
}
```
```{r, eval=FALSE}
path_to_file <- "PERSONAL/PATH/TO/DATA"
```

```{r}
ranidae <- read_csv2(path_to_file, 
                    col_types = cols(year = col_double(),
                                     month = col_double(),
                                     lon = col_double(),
                                     lat = col_double()))
```

```{r}
# Construct a continuous temporal predictor combining year and month
ranidae$year_month <- ranidae$year + (ranidae$month * 0.075)
```

```{r, echo = FALSE}
DT::datatable(ranidae, caption = "Table 1: Initial dataset structure.", options = list(scrollX = TRUE)) 
```

## 3. Environmental Data Extraction

If environmental response variables is not available, `SppTrend` facilitates the integration of geospatial environmental data (temperature and elevation).

### 3.1 Temperature (ERA5-Land)

`get_era5_tme()` to extract mean monthly temperatures (`tme`) from a ERA5-Land (`.nc`) file.

```{r, eval = FALSE}
ranidae <- get_era5_tme(data = ranidae,
                               nc_file = "personal/path/era5_land.nc")
```

### 3.2 Elevation (DEM)

`extract_elevation()`to obtain altitude (`ele`) from a Digital Elevation Model (`.tif`) file.

```{r, eval = FALSE}
ranidae <- extract_elevation(data = ranidae,
                                    dem_file = "personal/path/dem_wc21_30s.tif")
```
```{r, include = FALSE}
path_to_file <- system.file("extdata", "example_ranidae_tme_ele.csv", package = "SppTrend")
if (path_to_file == "") {
  path_to_file <- "../inst/extdata/example_ranidae_tme_ele.csv"
}

ranidae <- read_csv2(path_to_file, 
                    col_types = cols(year = col_double(),
                                     month = col_double(),
                                     lon = col_double(),
                                     lat = col_double(),
                                     year_month = col_double(),
                                     tme = col_double(),
                                     ele = col_double()))
```
```{r, echo = FALSE}
DT::datatable(ranidae, caption = "Table 2: Data with environmental variables.", options = list(scrollX = TRUE))
```

## 4. Trend analysis

The analysis is performed in two stages: estimating the baseline trend and then calculating species-specific deviations.

```{r}
predictor <- "year_month"

responses <- c("lat", "lon", "ele", "tme")

species_list <- unique(ranidae$species)

ranidae <- na.omit(ranidae)
```

### 4.1 Overall trend (OT)

The OT serves as a neutral reference, representing the average temporal change across all observations.

```{r}
overall_res <- overall_trend(ranidae, predictor = predictor, responses = responses)
```

```{r, echo = FALSE}
DT::datatable(overall_res, caption = "Table 3: Aggregate trends for all observations.", options = list(scrollX = TRUE))
```

### 4.2. Species-specific trends

Calculates individual slopes for each species, applying a minimum record threshold (`n_min`) to ensure model stability.

```{r}
spp_res <- spp_trend(ranidae, species_list, 
                     predictor = predictor, 
                     responses = responses, 
                     n_min = 5)
```

## 5. Ecological strategy classification

The `spp_strategy()` function categorizes species based on the significance and direction of their trends relative to the OT.

```{r}
strategy_res <- spp_strategy(spp_res, 
                             sig_level = 0.05, 
                             responses = c("lat", "lon", "tme", "ele"))
```
```{r, echo = FALSE}
DT::datatable(strategy_res, caption = "Table 4: Classification of biological strategies.", options = list(scrollX = TRUE))
```

## 6. Visualization

Visualizing the relationship between occurrence records and environmental shifts is useful for hypothesis generation.

### 6.1. Spatial distribution

*Lithobates sylvaticus* has been selected as an example of a species with Spatial Equatorward (SE) shift for visualization (see table 4).

```{r}
example_spp <- "Lithobates sylvaticus"
viz_data <- ranidae[ranidae$species == example_spp, ]
```

```{r, fig.width=12, fig.height=8, out.width="100%"}
world_map <- ne_countries(scale = "medium", returnclass = "sf")
ggplot() +
  geom_sf(data = world_map, fill = "#f9f9f9", color = "grey80") +
  geom_point(data = viz_data, aes(x = lon, y = lat, col = year), alpha = 0.6, size = 2) +
  scale_colour_viridis_c(option = "viridis", name = "Year") +
  labs(title = paste("Distribution of", example_spp),
       subtitle = paste("Total records:", nrow(viz_data)),
       x = "Longitude", y = "Latitude") +
  theme_minimal() +
  theme(axis.text = element_text(size = 8),
        legend.position = "bottom")
```

### Latitudinal trend plots

*Lithobates sylvaticus* latitudinal trend (red) compared against the community-wide OT (dashed black).

```{r, fig.width=12, fig.height=8, out.width="100%"}
ggplot() +
  geom_point(data = ranidae, aes(x = year_month, y = lat), color = "grey80", alpha = 0.3) + 
  geom_smooth(data = ranidae, aes(x = year_month, y = lat), 
              method = "lm", color = "black", linetype = "dashed", se = FALSE) +
  geom_smooth(data = viz_data, aes(x = year_month, y = lat), 
              method = "lm", color = "red", fill = "red", alpha = 0.2) +
  labs(title = paste("Latitudinal trend:", example_spp),
       subtitle = "SE",
       x = "Date", y = "Latitude") +
  theme_minimal()
```

### Temperature trend plot 

*Pelophylax nigromaculatus* has been selected as an example of a species with Thermal Tolerance (TT) for visualization (see table 4).

```{r, fig.width=12, fig.height=8, out.width="100%"}
example_spp <- "Pelophylax nigromaculatus"
viz_data <- ranidae[ranidae$species == example_spp, ]
ggplot() +
  geom_point(data = ranidae, aes(x = year_month, y = tme), color = "grey80", alpha = 0.3) + 
  geom_smooth(data = ranidae, aes(x = year_month, y = tme), 
              method = "lm", color = "black", linetype = "dashed", se = FALSE) +
  geom_smooth(data = viz_data, aes(x = year_month, y = tme), 
              method = "lm", color = "red", fill = "red", alpha = 0.2) +
  labs(title = paste("Temperature trend:", example_spp),
       subtitle = "TT",
       x = "Date", y = "Temperature (ÂºC)") +
  theme_minimal()
```

### Elevation trend plot

*Lithobates pipiens* has been selected as an example of a species with elevational Spatial Discordance (SD) for visualization (see table 4).

```{r, fig.width=12, fig.height=8, out.width="100%"}
example_spp <- "Lithobates pipiens"
viz_data <- ranidae[ranidae$species == example_spp, ]
ggplot() +
  geom_point(data = ranidae, aes(x = year_month, y = ele), color = "grey80", alpha = 0.3) + 
  geom_smooth(data = ranidae, aes(x = year_month, y = ele), 
              method = "lm", color = "black", linetype = "dashed", se = FALSE) +
  geom_smooth(data = viz_data, aes(x = year_month, y = ele), 
              method = "lm", color = "red", fill = "red", alpha = 0.2) +
  labs(title = paste("Elevation trend:", example_spp),
       subtitle = "SD",
       x = "Date", y = "Elevation (m)") +
  theme_minimal()
```

## Conclusions

**Disclaimer** 

The results presented in this vignette are based on a reduced sample of 10,000 records. These outputs are intended for demonstration purposes and should not be interpreted as definitive biological findings.

`SppTrend` provides a methodology for transforming raw occurrence data into interpretable ecological strategies. However, users are encouraged to account for potential sampling biases and heterogeneities in historical datasets to ensure the reliability of the estimated trends.
