},
Thermal_tme = if ("tme" %in% unique(responses)){
dplyr::first(Thermal_tme[!is.na(Thermal_tme)])
}else{
NA_character_
},
.groups = "drop"
) %>%
tidyr::pivot_wider(
names_from = hemisphere,
values_from = Spatial_lat_Poleward,
names_prefix = "lat_"
) %>%
dplyr::ungroup()
View(strategies)
Spatial_lat_Poleward = dplyr::first(Spatial_lat_Poleward)
spp_trend_result %>%
dplyr::select(dplyr::all_of(intersect(
required_cols, names(spp_trend_result)
))) %>%
dplyr::mutate(
Spatial_lat_Poleward = dplyr::case_when(
.data$responses == "lat" ~ classify_lat_poleward(
.data$pvalue,
.data$dif_pvalue,
.data$trend,
.data$hemisphere
),
TRUE ~ NA_character_
)
,
Spatial_lon = dplyr::case_when(
.data$responses == "lon" ~ classify_spatial_standard(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
),
Spatial_ele = dplyr::case_when(
.data$responses == "ele" ~ classify_spatial_standard(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
),
Thermal_tmx = dplyr::case_when(
.data$responses == "tmx" ~ classify_thermal(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
),
Thermal_tmn = dplyr::case_when(
.data$responses == "tmn" ~ classify_thermal(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
),
Thermal_tme = dplyr::case_when(
.data$responses == "tme" ~ classify_thermal(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
)
)
spp_trend_result %>%
dplyr::select(dplyr::all_of(intersect(
required_cols, names(spp_trend_result)
))) %>%
dplyr::mutate(
Spatial_lat_Poleward = dplyr::case_when(
.data$responses == "lat" ~ classify_lat_poleward(
.data$pvalue,
.data$dif_pvalue,
.data$trend,
.data$hemisphere
),
TRUE ~ NA_character_
),
Spatial_lon = dplyr::case_when(
.data$responses == "lon" ~ classify_spatial_standard(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
),
Spatial_ele = dplyr::case_when(
.data$responses == "ele" ~ classify_spatial_standard(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
),
Thermal_tmx = dplyr::case_when(
.data$responses == "tmx" ~ classify_thermal(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
),
Thermal_tmn = dplyr::case_when(
.data$responses == "tmn" ~ classify_thermal(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
),
Thermal_tme = dplyr::case_when(
.data$responses == "tme" ~ classify_thermal(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
)
) %>%
dplyr::group_by(species, hemisphere)
spp_trend_result %>%
dplyr::select(dplyr::all_of(intersect(
required_cols, names(spp_trend_result)
))) %>%
dplyr::mutate(
Spatial_lat_Poleward = dplyr::case_when(
.data$responses == "lat" ~ classify_lat_poleward(
.data$pvalue,
.data$dif_pvalue,
.data$trend,
.data$hemisphere
),
TRUE ~ NA_character_
),
Spatial_lon = dplyr::case_when(
.data$responses == "lon" ~ classify_spatial_standard(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
),
Spatial_ele = dplyr::case_when(
.data$responses == "ele" ~ classify_spatial_standard(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
),
Thermal_tmx = dplyr::case_when(
.data$responses == "tmx" ~ classify_thermal(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
),
Thermal_tmn = dplyr::case_when(
.data$responses == "tmn" ~ classify_thermal(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
),
Thermal_tme = dplyr::case_when(
.data$responses == "tme" ~ classify_thermal(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
)
) %>%
dplyr::group_by(species, hemisphere)
spp_trend_result %>%
dplyr::select(dplyr::all_of(intersect(
required_cols, names(spp_trend_result)
))) %>%
dplyr::mutate(
Spatial_lat_Poleward = dplyr::case_when(
.data$responses == "lat" ~ classify_lat_poleward(
.data$pvalue,
.data$dif_pvalue,
.data$trend,
.data$hemisphere
),
TRUE ~ NA_character_
),
Spatial_lon = dplyr::case_when(
.data$responses == "lon" ~ classify_spatial_standard(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
),
Spatial_ele = dplyr::case_when(
.data$responses == "ele" ~ classify_spatial_standard(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
),
Thermal_tmx = dplyr::case_when(
.data$responses == "tmx" ~ classify_thermal(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
),
Thermal_tmn = dplyr::case_when(
.data$responses == "tmn" ~ classify_thermal(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
),
Thermal_tme = dplyr::case_when(
.data$responses == "tme" ~ classify_thermal(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
)
) %>%
dplyr::group_by(species, hemisphere) %>%
dplyr::summarise(
n = sum(n),
Spatial_lat_Poleward = dplyr::first(Spatial_lat_Poleward),
Spatial_lon = if("lon" %in% unique(responses)){
dplyr::first(Spatial_lon[!is.na(Spatial_lon)])
}else{
NA_character_
},
Spatial_ele = if ("ele" %in% unique(responses)){
dplyr::first(Spatial_ele[!is.na(Spatial_ele)])
}else{
NA_character_
},
Thermal_tmx = if ("tmx" %in% unique(responses)){
dplyr::first(Thermal_tmx[!is.na(Thermal_tmx)])
}else{
NA_character_
},
Thermal_tmn = if ("tmn" %in% unique(responses)){
dplyr::first(Thermal_tmn[!is.na(Thermal_tmn)])
}else{
NA_character_
},
Thermal_tme = if ("tme" %in% unique(responses)){
dplyr::first(Thermal_tme[!is.na(Thermal_tme)])
}else{
NA_character_
},
.groups = "drop"
)
spp_trend_result %>%
dplyr::select(dplyr::all_of(intersect(
required_cols, names(spp_trend_result)
))) %>%
dplyr::mutate(
Spatial_lat_Poleward = dplyr::case_when(
.data$responses == "lat" ~ classify_lat_poleward(
.data$pvalue,
.data$dif_pvalue,
.data$trend,
.data$hemisphere
),
TRUE ~ NA_character_
),
Spatial_lon = dplyr::case_when(
.data$responses == "lon" ~ classify_spatial_standard(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
),
Spatial_ele = dplyr::case_when(
.data$responses == "ele" ~ classify_spatial_standard(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
),
Thermal_tmx = dplyr::case_when(
.data$responses == "tmx" ~ classify_thermal(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
),
Thermal_tmn = dplyr::case_when(
.data$responses == "tmn" ~ classify_thermal(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
),
Thermal_tme = dplyr::case_when(
.data$responses == "tme" ~ classify_thermal(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
)
) %>%
dplyr::group_by(species, hemisphere) %>%
dplyr::summarise(
n = sum(n),
Spatial_lat_Poleward = dplyr::first(Spatial_lat_Poleward),
Spatial_lon = if("lon" %in% unique(responses)){
dplyr::first(Spatial_lon[!is.na(Spatial_lon)])
}else{
NA_character_
},
Spatial_ele = if ("ele" %in% unique(responses)){
dplyr::first(Spatial_ele[!is.na(Spatial_ele)])
}else{
NA_character_
},
Thermal_tmx = if ("tmx" %in% unique(responses)){
dplyr::first(Thermal_tmx[!is.na(Thermal_tmx)])
}else{
NA_character_
},
Thermal_tmn = if ("tmn" %in% unique(responses)){
dplyr::first(Thermal_tmn[!is.na(Thermal_tmn)])
}else{
NA_character_
},
Thermal_tme = if ("tme" %in% unique(responses)){
dplyr::first(Thermal_tme[!is.na(Thermal_tme)])
}else{
NA_character_
},
.groups = "drop"
) %>%
tidyr::pivot_wider(
names_from = hemisphere,
values_from = Spatial_lat_Poleward,
names_prefix = "lat_"
)
spp_trend_result %>%
dplyr::select(dplyr::all_of(intersect(
required_cols, names(spp_trend_result)
))) %>%
dplyr::mutate(
Spatial_lat_Poleward = dplyr::case_when(
.data$responses == "lat" ~ classify_lat_poleward(
.data$pvalue,
.data$dif_pvalue,
.data$trend,
.data$hemisphere
),
TRUE ~ NA_character_
),
Spatial_lon = dplyr::case_when(
.data$responses == "lon" ~ classify_spatial_standard(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
),
Spatial_ele = dplyr::case_when(
.data$responses == "ele" ~ classify_spatial_standard(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
),
Thermal_tmx = dplyr::case_when(
.data$responses == "tmx" ~ classify_thermal(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
),
Thermal_tmn = dplyr::case_when(
.data$responses == "tmn" ~ classify_thermal(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
),
Thermal_tme = dplyr::case_when(
.data$responses == "tme" ~ classify_thermal(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
)
) %>%
dplyr::group_by(species, hemisphere) %>%
dplyr::summarise(
n = sum(n),
Spatial_lat_Poleward = dplyr::first(Spatial_lat_Poleward),
Spatial_lon = if("lon" %in% unique(responses)){
dplyr::first(Spatial_lon[!is.na(Spatial_lon)])
}else{
NA_character_
},
Spatial_ele = if ("ele" %in% unique(responses)){
dplyr::first(Spatial_ele[!is.na(Spatial_ele)])
}else{
NA_character_
},
Thermal_tmx = if ("tmx" %in% unique(responses)){
dplyr::first(Thermal_tmx[!is.na(Thermal_tmx)])
}else{
NA_character_
},
Thermal_tmn = if ("tmn" %in% unique(responses)){
dplyr::first(Thermal_tmn[!is.na(Thermal_tmn)])
}else{
NA_character_
},
Thermal_tme = if ("tme" %in% unique(responses)){
dplyr::first(Thermal_tme[!is.na(Thermal_tme)])
}else{
NA_character_
},
.groups = "drop"
) %>%
tidyr::pivot_wider(
names_from = hemisphere,
values_from = Spatial_lat_Poleward,
names_prefix = "Spatial_lat_"
)
#' sig_level <- 0.05 / length(spp) # Bonferroni
#' responses_to_analyze <- c("lat", "lon", "tme")
#'
#' spp_strategy_results <- spp_strategy(spp_trends_results,
#'                                      sig_level = sig_level,
#'                                      responses = responses_to_analyze)
#'
#' print(spp_strategy_results)
#'
#' @export
spp_strategy <- function(spp_trend_result,
sig_level = 0.05,
responses = responses) {
classify_spatial_standard <- function(pvalue, dif_pvalue, trend) {
dplyr::case_when(
pvalue > sig_level ~ "SC",
pvalue <= sig_level &
dif_pvalue <= sig_level & trend > 0 ~ "SA",
pvalue <= sig_level &
dif_pvalue <= sig_level & trend < 0 ~ "SD",
TRUE ~ "SC"
)
}
classify_lat_poleward <- function(pvalue, dif_pvalue, trend, hemisphere) {
dplyr::case_when(
pvalue > sig_level ~ "SC",
pvalue <= sig_level &
dif_pvalue <= sig_level &
trend > 0 & hemisphere == "North" ~ "SP",
pvalue <= sig_level &
dif_pvalue <= sig_level &
trend < 0 & hemisphere == "North" ~ "SE",
pvalue <= sig_level &
dif_pvalue <= sig_level &
trend > 0 & hemisphere == "South" ~ "SE",
pvalue <= sig_level &
dif_pvalue <= sig_level &
trend < 0 & hemisphere == "South" ~ "SP",
pvalue <= sig_level &
dif_pvalue <= sig_level &
trend > 0 & hemisphere == "Both" ~ "SA",
pvalue <= sig_level &
dif_pvalue <= sig_level &
trend < 0 & hemisphere == "Both" ~ "SD",
TRUE ~ "SC"
)
}
classify_thermal <- function(pvalue, dif_pvalue, trend) {
dplyr::case_when(
pvalue > sig_level ~ "TC",
pvalue <= sig_level &
dif_pvalue <= sig_level & trend < 0 ~ "TA",
pvalue <= sig_level &
dif_pvalue <= sig_level & trend > 0 ~ "TT",
TRUE ~ "TC"
)
}
required_cols <- c(
"species",
"trend",
"t",
"pvalue",
"responses",
"dif_t",
"dif_pvalue",
"n",
"hemisphere"
)
if (!all(required_cols %in% names(spp_trend_result))) {
missing_cols <- setdiff(required_cols, names(spp_trend_result))
stop(
paste(
"Error: The following columns were not found in 'spp_trend_result':",
paste(missing_cols, collapse = ", "),
". The required columns are:",
paste(required_cols, collapse = ", ")
)
)
}
strategies <- spp_trend_result %>%
dplyr::select(dplyr::all_of(intersect(
required_cols, names(spp_trend_result)
))) %>%
dplyr::mutate(
Spatial_lat_Poleward = dplyr::case_when(
.data$responses == "lat" ~ classify_lat_poleward(
.data$pvalue,
.data$dif_pvalue,
.data$trend,
.data$hemisphere
),
TRUE ~ NA_character_
),
Spatial_lon = dplyr::case_when(
.data$responses == "lon" ~ classify_spatial_standard(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
),
Spatial_ele = dplyr::case_when(
.data$responses == "ele" ~ classify_spatial_standard(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
),
Thermal_tmx = dplyr::case_when(
.data$responses == "tmx" ~ classify_thermal(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
),
Thermal_tmn = dplyr::case_when(
.data$responses == "tmn" ~ classify_thermal(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
),
Thermal_tme = dplyr::case_when(
.data$responses == "tme" ~ classify_thermal(.data$pvalue, .data$dif_pvalue, .data$trend),
TRUE ~ NA_character_
)
) %>%
dplyr::group_by(species, hemisphere) %>%
dplyr::summarise(
n = sum(n),
Spatial_lat_Poleward = dplyr::first(Spatial_lat_Poleward),
Spatial_lon = if("lon" %in% unique(responses)){
dplyr::first(Spatial_lon[!is.na(Spatial_lon)])
}else{
NA_character_
},
Spatial_ele = if ("ele" %in% unique(responses)){
dplyr::first(Spatial_ele[!is.na(Spatial_ele)])
}else{
NA_character_
},
Thermal_tmx = if ("tmx" %in% unique(responses)){
dplyr::first(Thermal_tmx[!is.na(Thermal_tmx)])
}else{
NA_character_
},
Thermal_tmn = if ("tmn" %in% unique(responses)){
dplyr::first(Thermal_tmn[!is.na(Thermal_tmn)])
}else{
NA_character_
},
Thermal_tme = if ("tme" %in% unique(responses)){
dplyr::first(Thermal_tme[!is.na(Thermal_tme)])
}else{
NA_character_
},
.groups = "drop"
) %>%
tidyr::pivot_wider(
names_from = hemisphere,
values_from = Spatial_lat_Poleward,
names_prefix = "Spatial_lat_"
) %>%
dplyr::ungroup()
}
puntos_muestra <- puntos_filtrados[sample(nrow(puntos_filtrados), 10000), ]
bb <- puntos_muestra
tic()
bb <- na.omit(bb)
bb$year_month  = bb$year + bb$month * 0.075
predictor <- "year_month"
spp <- unique(bb$species)
spp_trend_result <- spp_trend(bb, spp, predictor = "year_month", responses = c("lat", "lon","ele","tme"), n_min = 10)
print(spp_trend_result)
View(spp_trend_result)
tic()
spp_strategy_result <- spp_strategy(spp_trend_result, sig_level = 0.05, responses = c("lat", "lon", "tme", "ele"))
print(spp_strategy_result)
toc()
View(spp_strategy_result)
bb <- puntos_filtrados
tic()
bb <- na.omit(bb)
bb$year_month  = bb$year + bb$month * 0.075
predictor <- "year_month"
spp <- unique(bb$species)
spp_trend_result <- spp_trend(bb, spp, predictor = "year_month", responses = c("lat", "lon","ele","tme"), n_min = 10)
print(spp_trend_result)
toc()
tic()
spp_strategy_result <- spp_strategy(spp_trend_result, sig_level = 0.05, responses = c("lat", "lon", "tme", "ele"))
print(spp_strategy_result)
toc()
