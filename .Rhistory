#'
#' # Example interpretation: A positive 'trend' for 'lat' might indicate a
#' # northward shift in the Northern Hemisphere. A low 'pvalue' (e.g., < 0.05)
#' # suggests this trend is statistically significant. A low 'dif_pvalue'
#' # might indicate this trend is significantly different from the general trend.
#'
#' @export
#'
spp_trend <- function(data, spp, predictor, responses, n_min = 50) {
data$hemisphere <- ifelse(data$lat >= 0, "North", "South")
results_list <- list()
for (n in 1:length(spp)) {
ind <- data[data$species == spp[n], ]
hemispheres_present <- unique(ind$hemisphere)
ind_list <- split(ind, f = ind$hemisphere)
for (h in names(ind_list)) {
ind_hemisphere <- ind_list[[h]]
data_hemisphere <- data[data$hemisphere == h, ]
if (nrow(ind_hemisphere) > n_min) {
for (i in 1:length(responses)) {
tryCatch({
if (length(unique(ind_hemisphere[[predictor]])) > 1) {
current_resp <- responses[i]
cols_needed <- c(predictor, current_resp)
if (current_resp == "lon") {
ind_hemisphere$lon_transformed <- (ind_hemisphere$lon + 180) %% 360
data_hemisphere$lon_transformed <- (data_hemisphere$lon + 180) %% 360
target_var <- "lon_transformed"
cols_needed <- c(predictor, "lon_transformed")
} else {
target_var <- current_resp
}
sub_ind <- ind_hemisphere[, cols_needed, drop = FALSE]
sub_ind$group <- "i"
sub_gen <- data_hemisphere[, cols_needed, drop = FALSE]
sub_gen$group <- "g"
dat_model <- rbind(sub_ind, sub_gen)
formula_i <- as.formula(paste(target_var, "~", predictor))
formula_int <- as.formula(paste(target_var, "~", predictor, "* group"))
model_i <- lm(formula_i, data = ind_hemisphere)
model_int <- lm(formula_int, data = dat_model)
sum_i <- summary(model_i)$coefficients
sum_int <- summary(model_int)$coefficients
trend <- coef(model_i)[2]
t_value <- sum_i[2, 3]
p_value <- sum_i[2, 4]
ci <- confint(model_i, predictor, level = .95)
interaction_term <- paste0(predictor, ":groupi")
dif_t <- if (interaction_term %in% rownames(sum_int)) sum_int[interaction_term, 3] else NA
dif_p <- if (interaction_term %in% rownames(sum_int)) sum_int[interaction_term, 4] else NA
results_list[[length(results_list) + 1]] <- data.frame(
species = spp[n],
responses = current_resp,
trend = trend,
t = t_value,
pvalue = p_value,
ci_95_max = ci[1, 2],
ci_95_min = ci[1, 1],
dif_t = dif_t,
dif_pvalue = dif_p,
n = nrow(ind_hemisphere),
hemisphere = h,
stringsAsFactors = FALSE
)
} else {
message(paste("WARNING: Insufficient predictor variation for", spp[n], "in", h))
}
}, error = function(e) {
message(paste("ERROR in Specie", spp[n], "response", responses[i], "in", h, ":", e$message))
})
}
} else {
message(paste("WARNING: Specie", spp[n], "has few data (", nrow(ind_hemisphere), ") in", h))
}
}
if (all(c("North", "South") %in% hemispheres_present)) {
if (nrow(ind) > n_min) {
for (i in 1:length(responses)) {
tryCatch({
if (length(unique(ind[[predictor]])) > 1) {
current_resp <- responses[i]
cols_needed <- c(predictor, current_resp)
if (current_resp == "lon") {
ind$lon_transformed <- (ind$lon + 180) %% 360
data$lon_transformed <- (data$lon + 180) %% 360
target_var <- "lon_transformed"
cols_needed <- c(predictor, "lon_transformed")
} else {
target_var <- current_resp
}
sub_ind_g <- ind[, cols_needed, drop = FALSE]
sub_ind_g$group_global <- "i"
sub_gen_g <- data[, cols_needed, drop = FALSE]
sub_gen_g$group_global <- "g"
dat_global <- rbind(sub_ind_g, sub_gen_g)
model_i_g <- lm(as.formula(paste(target_var, "~", predictor)), data = ind)
model_int_g <- lm(as.formula(paste(target_var, "~", predictor, "* group_global")), data = dat_global)
sum_i_g <- summary(model_i_g)$coefficients
sum_int_g <- summary(model_int_g)$coefficients
ci_g <- confint(model_i_g, predictor, level = .95)
int_term_g <- paste0(predictor, ":group_globali")
results_list[[length(results_list) + 1]] <- data.frame(
species = spp[n],
responses = current_resp,
trend = coef(model_i_g)[2],
t = sum_i_g[2, 3],
pvalue = sum_i_g[2, 4],
ci_95_max = ci_g[1, 2],
ci_95_min = ci_g[1, 1],
dif_t = if (int_term_g %in% rownames(sum_int_g)) sum_int_g[int_term_g, 3] else NA,
dif_pvalue = if (int_term_g %in% rownames(sum_int_g)) sum_int_g[int_term_g, 4] else NA,
n = nrow(ind),
hemisphere = "Both",
stringsAsFactors = FALSE
)
}
}, error = function(e) {
message(paste("ERROR in Global analysis for", spp[n], ":", e$message))
})
}
}
}
}
if (length(results_list) > 0) {
return(do.call(rbind, results_list))
} else {
return(data.frame())
}
}
#'
#' print(head(spp_trend_result))
#'
#' # Example interpretation: A positive 'trend' for 'lat' might indicate a
#' # northward shift in the Northern Hemisphere. A low 'pvalue' (e.g., < 0.05)
#' # suggests this trend is statistically significant. A low 'dif_pvalue'
#' # might indicate this trend is significantly different from the general trend.
#'
#' @export
#'
spp_trend <- function(data, spp, predictor, responses, n_min = 50) {
data$hemisphere <- ifelse(data$lat >= 0, "North", "South")
results_list <- list()
for (n in 1:length(spp)) {
ind <- data[data$species == spp[n], ]
hemispheres_present <- unique(ind$hemisphere)
ind_list <- split(ind, f = ind$hemisphere)
for (h in names(ind_list)) {
ind_hemisphere <- ind_list[[h]]
data_hemisphere <- data[data$hemisphere == h, ]
if (nrow(ind_hemisphere) > n_min) {
for (i in 1:length(responses)) {
tryCatch({
current_resp <- responses[i]
if (current_resp == "lon") {
val_ind <- (ind_hemisphere$lon + 180) %% 360
val_gen <- (data_hemisphere$lon + 180) %% 360
} else {
val_ind <- ind_hemisphere[[current_resp]]
val_gen <- data_hemisphere[[current_resp]]
}
if (length(unique(ind_hemisphere[[predictor]])) > 1) {
df_ind <- data.frame(y = val_ind, time = ind_hemisphere[[predictor]], group = "i")
df_gen <- data.frame(y = val_gen, time = data_hemisphere[[predictor]], group = "g")
dat_model <- rbind(df_ind, df_gen)
model_i <- lm(y ~ time, data = df_ind)
model_int <- lm(y ~ time * group, data = dat_model)
sum_i <- summary(model_i)$coefficients
sum_int <- summary(model_int)$coefficients
ci <- confint(model_i, "time", level = .95)
int_term <- "time:groupi"
results_list[[length(results_list) + 1]] <- data.frame(
species = spp[n],
responses = current_resp,
trend = coef(model_i)[2],
t = sum_i[2, 3],
pvalue = sum_i[2, 4],
ci_95_max = ci[1, 2],
ci_95_min = ci[1, 1],
dif_t = if (int_term %in% rownames(sum_int)) sum_int[int_term, 3] else NA,
dif_pvalue = if (int_term %in% rownames(sum_int)) sum_int[int_term, 4] else NA,
n = nrow(ind_hemisphere),
hemisphere = h,
stringsAsFactors = FALSE
)
}
}, error = function(e) {
message(paste("Error en", spp[n], "-", responses[i], "(", h, "):", e$message))
})
}
}
}
if (all(c("North", "South") %in% hemispheres_present)) {
if (nrow(ind) > n_min) {
for (i in 1:length(responses)) {
tryCatch({
current_resp <- responses[i]
if (length(unique(ind[[predictor]])) > 1) {
if (current_resp == "lon") {
val_ind_g <- (ind$lon + 180) %% 360
val_gen_g <- (data$lon + 180) %% 360
} else {
val_ind_g <- ind[[current_resp]]
val_gen_g <- data[[current_resp]]
}
df_ind_g <- data.frame(y = val_ind_g, time = ind[[predictor]], group = "i")
df_gen_g <- data.frame(y = val_gen_g, time = data[[predictor]], group = "g")
dat_global <- rbind(df_ind_g, df_gen_g)
model_i_g <- lm(y ~ time, data = df_ind_g)
model_int_g <- lm(y ~ time * group, data = dat_global)
sum_i_g <- summary(model_i_g)$coefficients
sum_int_g <- summary(model_int_g)$coefficients
ci_g <- confint(model_i_g, "time", level = .95)
results_list[[length(results_list) + 1]] <- data.frame(
species = spp[n],
responses = current_resp,
trend = coef(model_i_g)[2],
t = sum_i_g[2, 3],
pvalue = sum_i_g[2, 4],
ci_95_max = ci_g[1, 2],
ci_95_min = ci_g[1, 1],
dif_t = if ("time:groupi" %in% rownames(sum_int_g)) sum_int_g["time:groupi", 3] else NA,
dif_pvalue = if ("time:groupi" %in% rownames(sum_int_g)) sum_int_g["time:groupi", 4] else NA,
n = nrow(ind),
hemisphere = "Both",
stringsAsFactors = FALSE
)
}
}, error = function(e) {
message(paste("Error global en", spp[n], "-", responses[i], ":", e$message))
})
}
}
}
}
if (length(results_list) > 0) return(do.call(rbind, results_list))
else return(data.frame())
}
library(sf)
library(terra)
library(stringr)
library(tictoc)
library(SppTrend)
#'
#' print(head(spp_trend_result))
#'
#' # Example interpretation: A positive 'trend' for 'lat' might indicate a
#' # northward shift in the Northern Hemisphere. A low 'pvalue' (e.g., < 0.05)
#' # suggests this trend is statistically significant. A low 'dif_pvalue'
#' # might indicate this trend is significantly different from the general trend.
#'
#' @export
#'
spp_trend <- function(data, spp, predictor, responses, n_min = 50) {
data$hemisphere <- ifelse(data$lat >= 0, "North", "South")
results_list <- list()
for (n in 1:length(spp)) {
ind <- data[data$species == spp[n], ]
hemispheres_present <- unique(ind$hemisphere)
ind_list <- split(ind, f = ind$hemisphere)
for (h in names(ind_list)) {
ind_hemisphere <- ind_list[[h]]
data_hemisphere <- data[data$hemisphere == h, ]
if (nrow(ind_hemisphere) > n_min) {
for (i in 1:length(responses)) {
tryCatch({
current_resp <- responses[i]
if (current_resp == "lon") {
val_ind <- (ind_hemisphere$lon + 180) %% 360
val_gen <- (data_hemisphere$lon + 180) %% 360
} else {
val_ind <- ind_hemisphere[[current_resp]]
val_gen <- data_hemisphere[[current_resp]]
}
if (length(unique(ind_hemisphere[[predictor]])) > 1) {
df_ind <- data.frame(y = val_ind, time = ind_hemisphere[[predictor]], group = "i")
df_gen <- data.frame(y = val_gen, time = data_hemisphere[[predictor]], group = "g")
dat_model <- rbind(df_ind, df_gen)
model_i <- lm(y ~ time, data = df_ind)
model_int <- lm(y ~ time * group, data = dat_model)
sum_i <- summary(model_i)$coefficients
sum_int <- summary(model_int)$coefficients
ci <- confint(model_i, "time", level = .95)
int_term <- "time:groupi"
results_list[[length(results_list) + 1]] <- data.frame(
species = spp[n],
responses = current_resp,
trend = coef(model_i)[2],
t = sum_i[2, 3],
pvalue = sum_i[2, 4],
ci_95_max = ci[1, 2],
ci_95_min = ci[1, 1],
dif_t = if (int_term %in% rownames(sum_int)) sum_int[int_term, 3] else NA,
dif_pvalue = if (int_term %in% rownames(sum_int)) sum_int[int_term, 4] else NA,
n = nrow(ind_hemisphere),
hemisphere = h,
stringsAsFactors = FALSE
)
}
}, error = function(e) {
message(paste("Error en", spp[n], "-", responses[i], "(", h, "):", e$message))
})
}
}
}
if (all(c("North", "South") %in% hemispheres_present)) {
if (nrow(ind) > n_min) {
for (i in 1:length(responses)) {
tryCatch({
current_resp <- responses[i]
if (length(unique(ind[[predictor]])) > 1) {
if (current_resp == "lon") {
val_ind_g <- (ind$lon + 180) %% 360
val_gen_g <- (data$lon + 180) %% 360
} else {
val_ind_g <- ind[[current_resp]]
val_gen_g <- data[[current_resp]]
}
df_ind_g <- data.frame(y = val_ind_g, time = ind[[predictor]], group = "i")
df_gen_g <- data.frame(y = val_gen_g, time = data[[predictor]], group = "g")
dat_global <- rbind(df_ind_g, df_gen_g)
model_i_g <- lm(y ~ time, data = df_ind_g)
model_int_g <- lm(y ~ time * group, data = dat_global)
sum_i_g <- summary(model_i_g)$coefficients
sum_int_g <- summary(model_int_g)$coefficients
ci_g <- confint(model_i_g, "time", level = .95)
results_list[[length(results_list) + 1]] <- data.frame(
species = spp[n],
responses = current_resp,
trend = coef(model_i_g)[2],
t = sum_i_g[2, 3],
pvalue = sum_i_g[2, 4],
ci_95_max = ci_g[1, 2],
ci_95_min = ci_g[1, 1],
dif_t = if ("time:groupi" %in% rownames(sum_int_g)) sum_int_g["time:groupi", 3] else NA,
dif_pvalue = if ("time:groupi" %in% rownames(sum_int_g)) sum_int_g["time:groupi", 4] else NA,
n = nrow(ind),
hemisphere = "Both",
stringsAsFactors = FALSE
)
}
}, error = function(e) {
message(paste("Error global en", spp[n], "-", responses[i], ":", e$message))
})
}
}
}
}
if (length(results_list) > 0) return(do.call(rbind, results_list))
else return(data.frame())
}
shapefile_path <- "C:/A_TRABAJO/A_JORGE/SPP_VIRTUALES/DATA_TEST/ranidae.shp"
puntos_sf <- st_read(shapefile_path)
puntos_df <- data.frame(
ID = rownames(puntos_sf),
species = puntos_sf$species,
lon = st_coordinates(puntos_sf)[, "X"],
lat = st_coordinates(puntos_sf)[, "Y"],
year = puntos_sf$year,
month = puntos_sf$month
)
puntos_filtrados <- puntos_df[puntos_df$year >= 1950, ]
puntos_muestra <- puntos_filtrados[sample(nrow(puntos_filtrados), 100), ]
tic()
aa <- get_era5_tme(data = puntos_muestra, nc_file = "C:/A_TRABAJO/A_JORGE/SPP_VIRTUALES/ERA5_land/era5_land.nc")
print("TIEMPO get_era5_tme")
toc()
tic()
aa <- extract_elevation(
data = aa,
dem_file = "C:/A_TRABAJO/A_JORGE/SPP_VIRTUALES/DEM/dem_wc21_30s.tif")
print("TIEMPO extract_elevation")
toc()
tic()
# print(nrow(aa))
# aa <- na.omit(aa)
# print(nrow(aa))
aa$year_month  = aa$year + aa$month * 0.075
predictor <- "year_month"
spp <- unique(aa$species)
spp_trend_result <- spp_trend(aa, spp, predictor = "year_month", responses = c("lat", "lon","ele","tme"), n_min = 5)
print("TIEMPO spp_trend")
toc()
spp_strategy_result <- spp_strategy(spp_trend_result, sig_level = 0.05, responses = c("lat", "lon", "tme", "ele"))
View(spp_strategy_result)
#'
#' print(head(spp_trend_result))
#'
#' # Example interpretation: A positive 'trend' for 'lat' might indicate a
#' # northward shift in the Northern Hemisphere. A low 'pvalue' (e.g., < 0.05)
#' # suggests this trend is statistically significant. A low 'dif_pvalue'
#' # might indicate this trend is significantly different from the general trend.
#'
#' @export
#'
spp_trend <- function(data, spp, predictor, responses, n_min = 50) {
data$hemisphere <- ifelse(data$lat >= 0, "North", "South")
results_list <- list()
for (n in 1:length(spp)) {
ind <- data[data$species == spp[n], ]
hemispheres_present <- unique(ind$hemisphere)
ind_list <- split(ind, f = ind$hemisphere)
for (h in names(ind_list)) {
ind_hemisphere <- ind_list[[h]]
data_hemisphere <- data[data$hemisphere == h, ]
if (nrow(ind_hemisphere) > n_min) {
for (i in 1:length(responses)) {
tryCatch({
current_resp <- responses[i]
if (current_resp == "lon") {
val_ind <- (ind_hemisphere$lon + 180) %% 360
val_gen <- (data_hemisphere$lon + 180) %% 360
} else {
val_ind <- ind_hemisphere[[current_resp]]
val_gen <- data_hemisphere[[current_resp]]
}
if (length(unique(ind_hemisphere[[predictor]])) > 1) {
df_ind <- data.frame(y = val_ind, time = ind_hemisphere[[predictor]], group = "i")
df_gen <- data.frame(y = val_gen, time = data_hemisphere[[predictor]], group = "g")
dat_model <- rbind(df_ind, df_gen)
model_i <- lm(y ~ time, data = df_ind)
model_int <- lm(y ~ time * group, data = dat_model)
sum_i <- summary(model_i)$coefficients
sum_int <- summary(model_int)$coefficients
ci <- confint(model_i, "time", level = .95)
int_term <- "time:groupi"
results_list[[length(results_list) + 1]] <- data.frame(
species = spp[n],
responses = current_resp,
trend = coef(model_i)[2],
t = sum_i[2, 3],
pvalue = sum_i[2, 4],
ci_95_max = ci[1, 2],
ci_95_min = ci[1, 1],
dif_t = if (int_term %in% rownames(sum_int)) sum_int[int_term, 3] else NA,
dif_pvalue = if (int_term %in% rownames(sum_int)) sum_int[int_term, 4] else NA,
n = nrow(ind_hemisphere),
hemisphere = h,
stringsAsFactors = FALSE
)
}
}, error = function(e) {
message(paste("Error en", spp[n], "-", responses[i], "(", h, "):", e$message))
})
}
}
}
if (all(c("North", "South") %in% hemispheres_present)) {
if (nrow(ind) > n_min) {
for (i in 1:length(responses)) {
tryCatch({
current_resp <- responses[i]
if (length(unique(ind[[predictor]])) > 1) {
if (current_resp == "lon") {
val_ind_g <- (ind$lon + 180) %% 360
val_gen_g <- (data$lon + 180) %% 360
} else {
val_ind_g <- ind[[current_resp]]
val_gen_g <- data[[current_resp]]
}
df_ind_g <- data.frame(y = val_ind_g, time = ind[[predictor]], group = "i")
df_gen_g <- data.frame(y = val_gen_g, time = data[[predictor]], group = "g")
dat_global <- rbind(df_ind_g, df_gen_g)
model_i_g <- lm(y ~ time, data = df_ind_g)
model_int_g <- lm(y ~ time * group, data = dat_global)
sum_i_g <- summary(model_i_g)$coefficients
sum_int_g <- summary(model_int_g)$coefficients
ci_g <- confint(model_i_g, "time", level = .95)
results_list[[length(results_list) + 1]] <- data.frame(
species = spp[n],
responses = current_resp,
trend = coef(model_i_g)[2],
t = sum_i_g[2, 3],
pvalue = sum_i_g[2, 4],
ci_95_max = ci_g[1, 2],
ci_95_min = ci_g[1, 1],
dif_t = if ("time:groupi" %in% rownames(sum_int_g)) sum_int_g["time:groupi", 3] else NA,
dif_pvalue = if ("time:groupi" %in% rownames(sum_int_g)) sum_int_g["time:groupi", 4] else NA,
n = nrow(ind),
hemisphere = "Both",
stringsAsFactors = FALSE
)
}
}, error = function(e) {
message(paste("Error global en", spp[n], "-", responses[i], ":", e$message))
})
}
}
}
}
if (length(results_list) > 0) return(do.call(rbind, results_list))
else return(data.frame())
}
document()
document()
build()
document()
build()
library(SppTrend)
library(devtools)
document()
document()
build()
library(devtools)
document()
check()
build()
library(devtools)
document()
build()
remove.packages("SppTrend")
library(devtools)
document()
