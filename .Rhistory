df_ind <- data.frame(y = val_ind, time = ind_hemisphere[[predictor]], group = "i")
df_gen <- data.frame(y = val_gen, time = data_hemisphere[[predictor]], group = "g")
dat_model <- rbind(df_ind, df_gen)
model_i <- lm(y ~ time, data = df_ind)
model_int <- lm(y ~ time * group, data = dat_model)
sum_i <- summary(model_i)$coefficients
sum_int <- summary(model_int)$coefficients
ci <- confint(model_i, "time", level = .95)
int_term <- "time:groupi"
results_list[[length(results_list) + 1]] <- data.frame(
species = spp[n],
responses = current_resp,
trend = coef(model_i)[2],
t = sum_i[2, 3],
pvalue = sum_i[2, 4],
ci_95_max = ci[1, 2],
ci_95_min = ci[1, 1],
dif_t = if (int_term %in% rownames(sum_int)) sum_int[int_term, 3] else NA,
dif_pvalue = if (int_term %in% rownames(sum_int)) sum_int[int_term, 4] else NA,
n = nrow(ind_hemisphere),
hemisphere = h,
stringsAsFactors = FALSE
)
}
}, error = function(e) {
message(paste("Error en", spp[n], "-", responses[i], "(", h, "):", e$message))
})
}
}
}
if (all(c("North", "South") %in% hemispheres_present)) {
if (nrow(ind) > n_min) {
for (i in 1:length(responses)) {
tryCatch({
current_resp <- responses[i]
if (length(unique(ind[[predictor]])) > 1) {
if (current_resp == "lon") {
val_ind_g <- (ind$lon + 180) %% 360
val_gen_g <- (data$lon + 180) %% 360
} else {
val_ind_g <- ind[[current_resp]]
val_gen_g <- data[[current_resp]]
}
df_ind_g <- data.frame(y = val_ind_g, time = ind[[predictor]], group = "i")
df_gen_g <- data.frame(y = val_gen_g, time = data[[predictor]], group = "g")
dat_global <- rbind(df_ind_g, df_gen_g)
model_i_g <- lm(y ~ time, data = df_ind_g)
model_int_g <- lm(y ~ time * group, data = dat_global)
sum_i_g <- summary(model_i_g)$coefficients
sum_int_g <- summary(model_int_g)$coefficients
ci_g <- confint(model_i_g, "time", level = .95)
results_list[[length(results_list) + 1]] <- data.frame(
species = spp[n],
responses = current_resp,
trend = coef(model_i_g)[2],
t = sum_i_g[2, 3],
pvalue = sum_i_g[2, 4],
ci_95_max = ci_g[1, 2],
ci_95_min = ci_g[1, 1],
dif_t = if ("time:groupi" %in% rownames(sum_int_g)) sum_int_g["time:groupi", 3] else NA,
dif_pvalue = if ("time:groupi" %in% rownames(sum_int_g)) sum_int_g["time:groupi", 4] else NA,
n = nrow(ind),
hemisphere = "Both",
stringsAsFactors = FALSE
)
}
}, error = function(e) {
message(paste("Error global en", spp[n], "-", responses[i], ":", e$message))
})
}
}
}
}
if (length(results_list) > 0) return(do.call(rbind, results_list))
else return(data.frame())
}
library(sf)
library(terra)
library(stringr)
library(tictoc)
library(SppTrend)
#'
#' print(head(spp_trend_result))
#'
#' # Example interpretation: A positive 'trend' for 'lat' might indicate a
#' # northward shift in the Northern Hemisphere. A low 'pvalue' (e.g., < 0.05)
#' # suggests this trend is statistically significant. A low 'dif_pvalue'
#' # might indicate this trend is significantly different from the general trend.
#'
#' @export
#'
spp_trend <- function(data, spp, predictor, responses, n_min = 50) {
data$hemisphere <- ifelse(data$lat >= 0, "North", "South")
results_list <- list()
for (n in 1:length(spp)) {
ind <- data[data$species == spp[n], ]
hemispheres_present <- unique(ind$hemisphere)
ind_list <- split(ind, f = ind$hemisphere)
for (h in names(ind_list)) {
ind_hemisphere <- ind_list[[h]]
data_hemisphere <- data[data$hemisphere == h, ]
if (nrow(ind_hemisphere) > n_min) {
for (i in 1:length(responses)) {
tryCatch({
current_resp <- responses[i]
if (current_resp == "lon") {
val_ind <- (ind_hemisphere$lon + 180) %% 360
val_gen <- (data_hemisphere$lon + 180) %% 360
} else {
val_ind <- ind_hemisphere[[current_resp]]
val_gen <- data_hemisphere[[current_resp]]
}
if (length(unique(ind_hemisphere[[predictor]])) > 1) {
df_ind <- data.frame(y = val_ind, time = ind_hemisphere[[predictor]], group = "i")
df_gen <- data.frame(y = val_gen, time = data_hemisphere[[predictor]], group = "g")
dat_model <- rbind(df_ind, df_gen)
model_i <- lm(y ~ time, data = df_ind)
model_int <- lm(y ~ time * group, data = dat_model)
sum_i <- summary(model_i)$coefficients
sum_int <- summary(model_int)$coefficients
ci <- confint(model_i, "time", level = .95)
int_term <- "time:groupi"
results_list[[length(results_list) + 1]] <- data.frame(
species = spp[n],
responses = current_resp,
trend = coef(model_i)[2],
t = sum_i[2, 3],
pvalue = sum_i[2, 4],
ci_95_max = ci[1, 2],
ci_95_min = ci[1, 1],
dif_t = if (int_term %in% rownames(sum_int)) sum_int[int_term, 3] else NA,
dif_pvalue = if (int_term %in% rownames(sum_int)) sum_int[int_term, 4] else NA,
n = nrow(ind_hemisphere),
hemisphere = h,
stringsAsFactors = FALSE
)
}
}, error = function(e) {
message(paste("Error en", spp[n], "-", responses[i], "(", h, "):", e$message))
})
}
}
}
if (all(c("North", "South") %in% hemispheres_present)) {
if (nrow(ind) > n_min) {
for (i in 1:length(responses)) {
tryCatch({
current_resp <- responses[i]
if (length(unique(ind[[predictor]])) > 1) {
if (current_resp == "lon") {
val_ind_g <- (ind$lon + 180) %% 360
val_gen_g <- (data$lon + 180) %% 360
} else {
val_ind_g <- ind[[current_resp]]
val_gen_g <- data[[current_resp]]
}
df_ind_g <- data.frame(y = val_ind_g, time = ind[[predictor]], group = "i")
df_gen_g <- data.frame(y = val_gen_g, time = data[[predictor]], group = "g")
dat_global <- rbind(df_ind_g, df_gen_g)
model_i_g <- lm(y ~ time, data = df_ind_g)
model_int_g <- lm(y ~ time * group, data = dat_global)
sum_i_g <- summary(model_i_g)$coefficients
sum_int_g <- summary(model_int_g)$coefficients
ci_g <- confint(model_i_g, "time", level = .95)
results_list[[length(results_list) + 1]] <- data.frame(
species = spp[n],
responses = current_resp,
trend = coef(model_i_g)[2],
t = sum_i_g[2, 3],
pvalue = sum_i_g[2, 4],
ci_95_max = ci_g[1, 2],
ci_95_min = ci_g[1, 1],
dif_t = if ("time:groupi" %in% rownames(sum_int_g)) sum_int_g["time:groupi", 3] else NA,
dif_pvalue = if ("time:groupi" %in% rownames(sum_int_g)) sum_int_g["time:groupi", 4] else NA,
n = nrow(ind),
hemisphere = "Both",
stringsAsFactors = FALSE
)
}
}, error = function(e) {
message(paste("Error global en", spp[n], "-", responses[i], ":", e$message))
})
}
}
}
}
if (length(results_list) > 0) return(do.call(rbind, results_list))
else return(data.frame())
}
shapefile_path <- "C:/A_TRABAJO/A_JORGE/SPP_VIRTUALES/DATA_TEST/ranidae.shp"
puntos_sf <- st_read(shapefile_path)
puntos_df <- data.frame(
ID = rownames(puntos_sf),
species = puntos_sf$species,
lon = st_coordinates(puntos_sf)[, "X"],
lat = st_coordinates(puntos_sf)[, "Y"],
year = puntos_sf$year,
month = puntos_sf$month
)
puntos_filtrados <- puntos_df[puntos_df$year >= 1950, ]
puntos_muestra <- puntos_filtrados[sample(nrow(puntos_filtrados), 100), ]
tic()
aa <- get_era5_tme(data = puntos_muestra, nc_file = "C:/A_TRABAJO/A_JORGE/SPP_VIRTUALES/ERA5_land/era5_land.nc")
print("TIEMPO get_era5_tme")
toc()
tic()
aa <- extract_elevation(
data = aa,
dem_file = "C:/A_TRABAJO/A_JORGE/SPP_VIRTUALES/DEM/dem_wc21_30s.tif")
print("TIEMPO extract_elevation")
toc()
tic()
# print(nrow(aa))
# aa <- na.omit(aa)
# print(nrow(aa))
aa$year_month  = aa$year + aa$month * 0.075
predictor <- "year_month"
spp <- unique(aa$species)
spp_trend_result <- spp_trend(aa, spp, predictor = "year_month", responses = c("lat", "lon","ele","tme"), n_min = 5)
print("TIEMPO spp_trend")
toc()
spp_strategy_result <- spp_strategy(spp_trend_result, sig_level = 0.05, responses = c("lat", "lon", "tme", "ele"))
View(spp_strategy_result)
#'
#' print(head(spp_trend_result))
#'
#' # Example interpretation: A positive 'trend' for 'lat' might indicate a
#' # northward shift in the Northern Hemisphere. A low 'pvalue' (e.g., < 0.05)
#' # suggests this trend is statistically significant. A low 'dif_pvalue'
#' # might indicate this trend is significantly different from the general trend.
#'
#' @export
#'
spp_trend <- function(data, spp, predictor, responses, n_min = 50) {
data$hemisphere <- ifelse(data$lat >= 0, "North", "South")
results_list <- list()
for (n in 1:length(spp)) {
ind <- data[data$species == spp[n], ]
hemispheres_present <- unique(ind$hemisphere)
ind_list <- split(ind, f = ind$hemisphere)
for (h in names(ind_list)) {
ind_hemisphere <- ind_list[[h]]
data_hemisphere <- data[data$hemisphere == h, ]
if (nrow(ind_hemisphere) > n_min) {
for (i in 1:length(responses)) {
tryCatch({
current_resp <- responses[i]
if (current_resp == "lon") {
val_ind <- (ind_hemisphere$lon + 180) %% 360
val_gen <- (data_hemisphere$lon + 180) %% 360
} else {
val_ind <- ind_hemisphere[[current_resp]]
val_gen <- data_hemisphere[[current_resp]]
}
if (length(unique(ind_hemisphere[[predictor]])) > 1) {
df_ind <- data.frame(y = val_ind, time = ind_hemisphere[[predictor]], group = "i")
df_gen <- data.frame(y = val_gen, time = data_hemisphere[[predictor]], group = "g")
dat_model <- rbind(df_ind, df_gen)
model_i <- lm(y ~ time, data = df_ind)
model_int <- lm(y ~ time * group, data = dat_model)
sum_i <- summary(model_i)$coefficients
sum_int <- summary(model_int)$coefficients
ci <- confint(model_i, "time", level = .95)
int_term <- "time:groupi"
results_list[[length(results_list) + 1]] <- data.frame(
species = spp[n],
responses = current_resp,
trend = coef(model_i)[2],
t = sum_i[2, 3],
pvalue = sum_i[2, 4],
ci_95_max = ci[1, 2],
ci_95_min = ci[1, 1],
dif_t = if (int_term %in% rownames(sum_int)) sum_int[int_term, 3] else NA,
dif_pvalue = if (int_term %in% rownames(sum_int)) sum_int[int_term, 4] else NA,
n = nrow(ind_hemisphere),
hemisphere = h,
stringsAsFactors = FALSE
)
}
}, error = function(e) {
message(paste("Error en", spp[n], "-", responses[i], "(", h, "):", e$message))
})
}
}
}
if (all(c("North", "South") %in% hemispheres_present)) {
if (nrow(ind) > n_min) {
for (i in 1:length(responses)) {
tryCatch({
current_resp <- responses[i]
if (length(unique(ind[[predictor]])) > 1) {
if (current_resp == "lon") {
val_ind_g <- (ind$lon + 180) %% 360
val_gen_g <- (data$lon + 180) %% 360
} else {
val_ind_g <- ind[[current_resp]]
val_gen_g <- data[[current_resp]]
}
df_ind_g <- data.frame(y = val_ind_g, time = ind[[predictor]], group = "i")
df_gen_g <- data.frame(y = val_gen_g, time = data[[predictor]], group = "g")
dat_global <- rbind(df_ind_g, df_gen_g)
model_i_g <- lm(y ~ time, data = df_ind_g)
model_int_g <- lm(y ~ time * group, data = dat_global)
sum_i_g <- summary(model_i_g)$coefficients
sum_int_g <- summary(model_int_g)$coefficients
ci_g <- confint(model_i_g, "time", level = .95)
results_list[[length(results_list) + 1]] <- data.frame(
species = spp[n],
responses = current_resp,
trend = coef(model_i_g)[2],
t = sum_i_g[2, 3],
pvalue = sum_i_g[2, 4],
ci_95_max = ci_g[1, 2],
ci_95_min = ci_g[1, 1],
dif_t = if ("time:groupi" %in% rownames(sum_int_g)) sum_int_g["time:groupi", 3] else NA,
dif_pvalue = if ("time:groupi" %in% rownames(sum_int_g)) sum_int_g["time:groupi", 4] else NA,
n = nrow(ind),
hemisphere = "Both",
stringsAsFactors = FALSE
)
}
}, error = function(e) {
message(paste("Error global en", spp[n], "-", responses[i], ":", e$message))
})
}
}
}
}
if (length(results_list) > 0) return(do.call(rbind, results_list))
else return(data.frame())
}
document()
document()
build()
document()
build()
library(SppTrend)
library(devtools)
document()
document()
build()
library(devtools)
document()
check()
build()
library(devtools)
document()
build()
remove.packages("SppTrend")
library(devtools)
document()
library(devtools)
document()
build()
library(shiny)
library(ggplot2)
library(dplyr)
library(sf)
library(viridis)
library(rnaturalearth)
library(rnaturalearthdata)
# Supongamos que `Data` es tu dataframe y `world_map` es el shapefile del mapa mundial
# Carga tu dataframe y el shapefile del mapa mundial aqu√≠
Data <- readRDS("C:/TRABAJO/SPP_VIRTUALES/DATA/ALEATORIAS/selected_ocs_percent_0.01.rds") # Cargamos datos
Data <- readRDS("C:/A_TRABAJO/A_JORGE/SPP_VIRTUALES/DATA/ALEATORIAS/selected_ocs_percent_0.01.rds") # Cargamos datos
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>",
warning = FALSE,
message = FALSE
)
library(SppTrend)
library(readr)
library(tictoc)
library(knitr)
# Load occurrence data from local directory
# Replace path with your local file: "C:/path/to/ranidae.csv"
ranidae <- read_csv("C:/A_TRABAJO/A_JORGE/SPP_VIRTUALES/TEST/TEST_PKG/ranidae.CSV",
col_types = cols(year = col_double(),
month = col_double(),
lon = col_double(),
lat = col_double()))
# Filter records from 1950 onwards to maintain temporal relevance
filtered_points <- ranidae[ranidae$year >= 1950, ]
# Subsample data to optimize computational performance
set.seed(123) # For reproducibility
sampled_points <- filtered_points[sample(nrow(filtered_points), 100), ]
# Construct a continuous temporal predictor combining year and month
sampled_points$year_month <- sampled_points$year + (sampled_points$month * 0.075)
kable(head(sampled_points), caption = "Table 1: Initial dataset structure.")
sampled_points <- get_era5_tme(data = sampled_points,
nc_file = "C:/A_TRABAJO/A_JORGE/SPP_VIRTUALES/ERA5_land/era5_land.nc")
sampled_points <- extract_elevation(data = sampled_points,
dem_file = "C:/A_TRABAJO/A_JORGE/SPP_VIRTUALES/DEM/dem_wc21_30s.tif")
# Define the temporal predictor and response variables
predictor <- "year_month"
responses <- c("lat", "lon", "ele", "tme")
species_list <- unique(sampled_points$species)
# Handle missing values to ensure model stability
sampled_points <- na.omit(sampled_points)
overall_res <- overall_trend(sampled_points, predictor = predictor, responses = responses)
spp_res <- spp_trend(sampled_points, species_list,
predictor = predictor,
responses = responses,
n_min = 5)
strategy_res <- spp_strategy(spp_res,
sig_level = 0.05,
responses = c("lat", "lon", "tme", "ele"))
View(strategy_res)
sampled_points <- filtered_points[sample(nrow(filtered_points), 1000), ]
# Construct a continuous temporal predictor combining year and month
sampled_points$year_month <- sampled_points$year + (sampled_points$month * 0.075)
sampled_points <- get_era5_tme(data = sampled_points,
nc_file = "C:/A_TRABAJO/A_JORGE/SPP_VIRTUALES/ERA5_land/era5_land.nc")
sampled_points <- get_era5_tme(data = sampled_points,
nc_file = "C:/A_TRABAJO/A_JORGE/SPP_VIRTUALES/ERA5_land/era5_land.nc")
sampled_points <- extract_elevation(data = sampled_points,
dem_file = "C:/A_TRABAJO/A_JORGE/SPP_VIRTUALES/DEM/dem_wc21_30s.tif")
predictor <- "year_month"
responses <- c("lat", "lon", "ele", "tme")
species_list <- unique(sampled_points$species)
# Handle missing values to ensure model stability
sampled_points <- na.omit(sampled_points)
overall_res <- overall_trend(sampled_points, predictor = predictor, responses = responses)
spp_res <- spp_trend(sampled_points, species_list,
predictor = predictor,
responses = responses,
n_min = 5)
strategy_res <- spp_strategy(spp_res,
sig_level = 0.05,
responses = c("lat", "lon", "tme", "ele"))
View(strategy_res)
example_spp <- "Lithobates pipiens"
viz_data <- sampled_points[sampled_points$species == example_spp, ]
ggplot() +
geom_point(data = sampled_points, aes(x = year_month, y = tme), color = "grey80", alpha = 0.3) +
geom_smooth(data = sampled_points, aes(x = year_month, y = tme),
method = "lm", color = "black", linetype = "dashed", se = FALSE) +
geom_smooth(data = viz_data, aes(x = year_month, y = tme),
method = "lm", color = "red", fill = "red", alpha = 0.2) +
labs(title = paste("Temperature trend:", example_spp),
x = "Year", y = "Latitude") +
theme_minimal()
library(DT)
DT::datatable(head(sampled_points, 20), caption = "Table 1: Initial dataset structure.", options = list(scrollX = TRUE, pageLength = 5))
# Subsample data to optimize computational performance
set.seed(123) # For reproducibility
sampled_points <- filtered_points[sample(nrow(filtered_points), 10000), ]
write.csv2(sampled_points, "C:/A_TRABAJO/A_JORGE/SPP_VIRTUALES/TEST/TEST_PKG/EXAMPLE_ranidae.CSV")
ranidae <- read_csv("C:/GITHUB/SppTrend/inst/extdata/example_ranidae.CSV",
col_types = cols(year = col_double(),
month = col_double(),
lon = col_double(),
lat = col_double()))
# Construct a continuous temporal predictor combining year and month
ranidae$year_month <- ranidae$year + (ranidae$month * 0.075)
ranidae$year_month <- ranidae$year
ranidae <- read_csv("C:/GITHUB/SppTrend/inst/extdata/example_ranidae.CSV",
col_types = cols(year = col_double(),
month = col_double(),
lon = col_double(),
lat = col_double()))
View(ranidae)
ranidae <- read_csv("C:/GITHUB/SppTrend/inst/extdata/example_ranidae.CSV",
col_types = cols(year = col_double(),
month = col_double(),
lon = col_double(),
lat = col_double()))
ranidae <- read_csv("C:/GITHUB/SppTrend/inst/extdata/example_ranidae.CSV",
delim = ";",
col_types = cols(year = col_double(),
month = col_double(),
lon = col_double(),
lat = col_double()))
ranidae <- read_csv2("C:/GITHUB/SppTrend/inst/extdata/example_ranidae.CSV",
col_types = cols(year = col_double(),
month = col_double(),
lon = col_double(),
lat = col_double()))
# Construct a continuous temporal predictor combining year and month
ranidae$year_month <- ranidae$year + (ranidae$month * 0.075)
ranidae <- read_csv2("C:/GITHUB/SppTrend/inst/extdata/example_ranidae.CSV",
col_types = cols(year = col_double(),
month = col_double(),
lon = col_double(),
lat = col_double()))
# Construct a continuous temporal predictor combining year and month
ranidae$year_month <- ranidae$year + (ranidae$month * 0.075)
ranidae <- get_era5_tme(data = ranidae,
nc_file = "C:/A_TRABAJO/A_JORGE/SPP_VIRTUALES/ERA5_land/era5_land.nc")
View(ranidae)
ranidae <- get_era5_tme(data = ranidae,
nc_file = "C:/A_TRABAJO/A_JORGE/SPP_VIRTUALES/ERA5_land/era5_land.nc")
ranidae <- extract_elevation(data = ranidae,
dem_file = "C:/A_TRABAJO/A_JORGE/SPP_VIRTUALES/DEM/dem_wc21_30s.tif")
write.csv2(ranidae,"C:/GITHUB/SppTrend/inst/extdata/example_ranidae_tme_ele.csv")
View(ranidae)
ranidae <- read_csv2("C:/GITHUB/SppTrend/inst/extdata/example_ranidae.CSV",
col_types = cols(year = col_double(),
month = col_double(),
lon = col_double(),
lat = col_double(),
tme = col_double(),
ele = col_double()))
View(ranidae)
library(devtools)
document()
check()
document()
document()
check()
build()
